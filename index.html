<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Oven Dashboard â€“ SMKN 4 Dumai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
.card{box-shadow:0 6px 18px rgba(0,0,0,.08)}
.matrix{display:grid;grid-template-columns:repeat(8,18px);gap:4px;justify-content:center}
.cell{width:18px;height:18px;background:#111;border-radius:2px}
.status{font-size:26px;font-weight:800;text-align:center;padding:16px;border-radius:14px}
.idle{background:#e5e7eb;color:#374151}
.log-box{max-height:200px;overflow:auto;font-size:13px}
body{
  background:
  linear-gradient(rgba(243,244,246,.85),rgba(243,244,246,.85)),
  url("./iot2.jpg") center/cover fixed;
}
</style>
</head>

<body>
<div class="max-w-7xl mx-auto p-6">

<!-- HEADER -->
<div class="flex items-center gap-3 mb-4">
  <img src="logo-SMKN4.png" class="h-12">
  <h1 class="text-2xl font-bold">Oven Control Dashboard â€“ SMKN 4 Dumai</h1>
</div>

<!-- ================= DASHBOARD UTAMA ================= -->
<div class="grid grid-cols-3 gap-4">

<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-3">Control Panel</h2>
  <button class="w-full bg-green-600 text-white py-2 rounded mb-2">â–¶ Start</button>
  <button class="w-full bg-yellow-500 text-white py-2 rounded mb-2">â›” Stop</button>
</div>

<div class="bg-white p-4 rounded card text-center">
  <h2 class="font-semibold mb-2">Live Status</h2>
  <div id="main-temp" class="text-3xl font-bold mb-3">-- Â°C</div>
  <div class="matrix mx-auto mb-3" id="matrix-main"></div>
  <div class="status idle">IDLE</div>
</div>

<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-2">Temperature Graph</h2>
  <canvas id="chart-main" height="180"></canvas>
</div>

</div>

<!-- ================= BAKING MODE ================= -->
<div class="grid grid-cols-2 gap-6 mt-8">

<!-- API ATAS -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-bold text-center mb-2">ğŸ”¥ Api Atas â€“ Max 160Â°C</h2>

  <div class="flex justify-between text-sm mb-2">
    <span>Timer: <b id="timer-top">15:00</b></span>
    <button id="alarm-top" class="bg-gray-600 text-white px-3 rounded text-xs">
      ğŸ”” Alarm OFF
    </button>
  </div>

  <div class="matrix mb-3" id="matrix-top"></div>
  <canvas id="chart-top" height="160"></canvas>

  <button id="add5-top" class="w-full bg-blue-500 text-white py-1 rounded mt-3">
    â± Tambah 5 Menit
  </button>
</div>

<!-- API BAWAH -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-bold text-center mb-2">ğŸ”¥ Api Bawah â€“ Max 180Â°C</h2>

  <div class="flex justify-between text-sm mb-2">
    <span>Timer: <b id="timer-bottom">15:00</b></span>
    <button id="alarm-bottom" class="bg-gray-600 text-white px-3 rounded text-xs">
      ğŸ”” Alarm OFF
    </button>
  </div>

  <div class="matrix mb-3" id="matrix-bottom"></div>
  <canvas id="chart-bottom" height="160"></canvas>

  <button id="add5-bottom" class="w-full bg-blue-500 text-white py-1 rounded mt-3">
    â± Tambah 5 Menit
  </button>
</div>

</div>
</div>

<script>
/* ================= CONFIG ================= */
const WS_URL = "wss://later-mainstream-bedroom-hygiene.trycloudflare.com";

/* ================= MATRIX ================= */
function buildMatrix(id){
  const m=document.getElementById(id);
  for(let i=0;i<64;i++){
    const d=document.createElement("div");
    d.className="cell";
    m.appendChild(d);
  }
}
["matrix-main","matrix-top","matrix-bottom"].forEach(buildMatrix);

/* ================= BLOOM ================= */
function bloom(matrix,temp,max){
  const c=3.5;
  const level=Math.min(temp/max,1)*4;
  for(let y=0;y<8;y++){
    for(let x=0;x<8;x++){
      const d=Math.max(Math.abs(x-c),Math.abs(y-c));
      matrix.children[y*8+x].style.background =
        d<=level ? "#f97316" : "#111";
    }
  }
}

/* ================= CHART ================= */
function makeChart(id,color){
  return new Chart(document.getElementById(id),{
    type:"line",
    data:{labels:[],datasets:[{data:[],borderColor:color,tension:.35}]},
    options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false}}}
  });
}
const chartMain=makeChart("chart-main","#ef4444");
const chartTop=makeChart("chart-top","#ef4444");
const chartBottom=makeChart("chart-bottom","#dc2626");

/* ================= WEBSOCKET ================= */
let ws;

function connectWS(){
  ws=new WebSocket(WS_URL);

  ws.onopen=()=>console.log("âœ… WS connected");

  ws.onclose=()=>setTimeout(connectWS,2000);

  ws.onmessage=e=>{
    const d=JSON.parse(e.data);

    main-temp.textContent=d.main_temp+" Â°C";
    bloom(matrix-main,d.main_temp,200);
    bloom(matrix-top,d.top_temp,160);
    bloom(matrix-bottom,d.bottom_temp,180);

    timer-top.textContent=
      Math.floor(d.top_remaining/60)+":"+
      String(d.top_remaining%60).padStart(2,"0");

    timer-bottom.textContent=
      Math.floor(d.bottom_remaining/60)+":"+
      String(d.bottom_remaining%60).padStart(2,"0");

    [chartMain,chartTop,chartBottom].forEach((c,i)=>{
      c.data.datasets[0].data.push(
        [d.main_temp,d.top_temp,d.bottom_temp][i]
      );
      if(c.data.datasets[0].data.length>60)
        c.data.datasets[0].data.shift();
      c.update();
    });
  };
}

connectWS();

/* ================= ALARM ================= */
function toggleAlarm(zone,btn){
  const on=btn.textContent.includes("OFF");
  btn.textContent=on?"ğŸ”” Alarm ON":"ğŸ”” Alarm OFF";
  btn.classList.toggle("bg-red-600",on);
  btn.classList.toggle("bg-gray-600",!on);

  ws.send(JSON.stringify({
    type:"alarm",
    zone:zone,
    value:on
  }));
}
alarm-top.onclick=()=>toggleAlarm("top",alarm-top);
alarm-bottom.onclick=()=>toggleAlarm("bottom",alarm-bottom);

/* ================= TIMER +5 ================= */
add5-top.onclick=()=>ws.send(JSON.stringify({type:"timer",zone:"top"}));
add5-bottom.onclick=()=>ws.send(JSON.stringify({type:"timer",zone:"bottom"}));
</script>

</body>
</html>
