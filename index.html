<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Oven Dashboard â€“ SMKN 4 Dumai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
.card{box-shadow:0 6px 18px rgba(0,0,0,.08)}
.matrix{display:grid;grid-template-columns:repeat(8,18px);gap:4px}
.cell{width:18px;height:18px;background:#000;border-radius:2px}

.status{font-size:28px;font-weight:800;text-align:center;padding:18px;border-radius:14px;transition:.4s}

body{
  background:
    linear-gradient(rgba(243,244,246,.75), rgba(243,244,246,.75)),
    url("./iot2.jpg") center/cover no-repeat fixed !important;
}

.idle{background:#e5e7eb;color:#374151}
.heating{background:linear-gradient(90deg,#dc2626,#f97316);color:white}
.normal{background:linear-gradient(90deg,#16a34a,#22c55e);color:white}
.warning{background:linear-gradient(90deg,#dc2626,#fde047);color:black;animation:pulse 1s infinite}
.shutdown{background:black;color:red;animation:blink .6s infinite}

@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}}

.log-box{max-height:220px;overflow:auto;font-size:13px}
.log-item{border-bottom:1px solid #eee;padding:4px 0}
</style>
</head>

<body>
<div class="max-w-6xl mx-auto p-6">

<div class="flex items-center gap-3 mb-4">
  <img src="logo-SMKN4.png" class="h-12">
  <h1 class="text-2xl font-bold">Oven Control Dashboard Realtime â€“ SMKN 4 Dumai</h1>
</div>

<div class="grid grid-cols-3 gap-4">

<!-- CONTROL -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-3">Control Panel</h2>

  <button id="btn-start" class="w-full bg-green-600 text-white py-2 rounded mb-2">â–¶ Start Heating</button>
  <button id="btn-stop" class="w-full bg-yellow-500 text-white py-2 rounded mb-2">â›” Stop</button>
  <button id="btn-reset" class="w-full bg-blue-600 text-white py-2 rounded mb-4 opacity-50 cursor-not-allowed" disabled>
    ðŸ”„ Reset (after shutdown)
  </button>
  <button id="btn-export" class="w-full bg-gray-700 text-white py-2 rounded">â¬‡ Export CSV</button>

  <div class="mt-4 text-sm">
    Connection: <span id="conn" class="font-bold text-red-600">Disconnected</span>
  </div>
</div>

<!-- STATUS -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-2">Live Status</h2>

  <div class="flex justify-between mb-4">
    <div>
      <div class="text-sm text-gray-500">Temperature</div>
      <div id="temp" class="text-3xl font-bold">-- Â°C</div>
    </div>
    <div>
      <div class="text-sm text-gray-500">Heating</div>
      <div id="heat" class="text-xl font-bold">--</div>
    </div>
  </div>

  <div class="matrix mb-4" id="matrix"></div>
  <div id="statusBox" class="status idle">IDLE</div>
</div>

<!-- GRAPH -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-2">Temperature Graph</h2>
  <canvas id="chart" height="200"></canvas>
</div>

</div>

<div class="bg-white p-4 rounded card mt-6">
  <h2 class="font-semibold mb-2">Event Log</h2>
  <div id="log" class="log-box"></div>
</div>

</div>

<script>
/* ========= CONFIG ========= */
const CONFIG = {
  WS_URL: "wss://music-holding-andy-frequency.trycloudflare.com",
  TOKEN: "SMKN4-OVEN-2025",
  RECONNECT: 2000
};

let ws, chart, tempData=[], logData=[];

/* MATRIX */
const matrix=document.getElementById("matrix");
for(let i=0;i<64;i++){let d=document.createElement("div");d.className="cell";matrix.appendChild(d);}

/* CHART */
chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[{data:[],borderColor:"red",tension:.3}]},
  options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false}}}
});

/* STATUS */
function setStatus(m){
  const s=document.getElementById("statusBox");
  s.className="status";
  s.textContent=m;
  s.classList.add(m.toLowerCase());
}

/* RESET */
function updateReset(m){
  const b=document.getElementById("btn-reset");
  b.disabled = m!=="SHUTDOWN";
  b.classList.toggle("opacity-50", m!=="SHUTDOWN");
  b.classList.toggle("cursor-not-allowed", m!=="SHUTDOWN");
}

/* LOG */
function addLog(t,temp,m){
  logData.unshift({t,temp,m});
  const d=document.createElement("div");
  d.className="log-item";
  d.textContent=`[${t}] ${temp}Â°C | ${m}`;
  document.getElementById("log").prepend(d);
}

/* WS */
function connectWS(){
  ws=new WebSocket(CONFIG.WS_URL);

  ws.onopen=()=>document.getElementById("conn").textContent="Connected";
  ws.onclose=()=>setTimeout(connectWS, CONFIG.RECONNECT);

  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    const t=new Date().toLocaleTimeString();
    document.getElementById("temp").textContent=d.temperature+" Â°C";
    document.getElementById("heat").textContent=d.heating_active?"ON":"OFF";
    setStatus(d.mode);
    updateReset(d.mode);
    addLog(t,d.temperature,d.mode);

    tempData.push(d.temperature);
    if(tempData.length>60)tempData.shift();
    chart.data.labels=tempData.map((_,i)=>i);
    chart.data.datasets[0].data=tempData;
    chart.update();
  };
}

/* SEND CONTROL */
function send(action){
  if(ws?.readyState===1){
    ws.send(JSON.stringify({type:"control",action,token:CONFIG.TOKEN}));
  }
}

document.getElementById("btn-start").onclick=()=>send("start_heating");
document.getElementById("btn-stop").onclick=()=>send("stop_heating");
document.getElementById("btn-reset").onclick=()=>send("reset");

connectWS();
</script>
</body>
</html>

