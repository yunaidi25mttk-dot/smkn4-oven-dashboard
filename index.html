<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Oven Dashboard â€“ SMKN 4 Dumai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
.card{box-shadow:0 6px 18px rgba(0,0,0,.08)}
.matrix{display:grid;grid-template-columns:repeat(8,18px);gap:4px;justify-content:center}
.cell{width:18px;height:18px;background:#1f2937;border-radius:2px}
body{
  background:linear-gradient(rgba(243,244,246,.85),rgba(243,244,246,.85));
}
</style>
</head>

<body>
<div class="max-w-7xl mx-auto p-6">

<h1 class="text-2xl font-bold mb-6">
  Oven Dashboard â€“ SMKN 4 Dumai
</h1>

<!-- ================= MAIN ================= -->
<div class="grid grid-cols-3 gap-4">

<div class="bg-white p-4 rounded card text-center">
  <h2 class="font-semibold mb-2">Oven Utama</h2>
  <div id="main-temp" class="text-3xl font-bold mb-2">-- Â°C</div>
  <div id="matrix-main" class="matrix"></div>
</div>

<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-2">Grafik Utama</h2>
  <canvas id="chart-main" height="180"></canvas>
</div>

<div class="bg-white p-4 rounded card">
  <h2 class="font-semibold mb-2">Status</h2>
  <div id="status" class="text-xl font-bold">MENUNGGU DATA</div>
</div>

</div>

<!-- ================= BAKING MODE ================= -->
<div class="grid grid-cols-2 gap-6 mt-8">

<!-- TOP -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-bold text-center mb-2">ğŸ”¥ Api Atas (160Â°C)</h2>

  <div class="flex justify-between text-sm mb-2">
    <span>Timer: <b id="timer-top">--:--</b></span>
    <button id="alarm-top"
      class="px-3 py-1 bg-gray-600 text-white rounded text-xs">
      ğŸ”” Alarm OFF
    </button>
  </div>

  <div id="matrix-top" class="matrix mb-3"></div>
  <canvas id="chart-top" height="160"></canvas>

  <button id="add5-top"
    class="w-full bg-blue-500 text-white py-1 rounded mt-2">
    â± Tambah 5 Menit
  </button>
</div>

<!-- BOTTOM -->
<div class="bg-white p-4 rounded card">
  <h2 class="font-bold text-center mb-2">ğŸ”¥ Api Bawah (180Â°C)</h2>

  <div class="flex justify-between text-sm mb-2">
    <span>Timer: <b id="timer-bottom">--:--</b></span>
    <button id="alarm-bottom"
      class="px-3 py-1 bg-gray-600 text-white rounded text-xs">
      ğŸ”” Alarm OFF
    </button>
  </div>

  <div id="matrix-bottom" class="matrix mb-3"></div>
  <canvas id="chart-bottom" height="160"></canvas>

  <button id="add5-bottom"
    class="w-full bg-blue-500 text-white py-1 rounded mt-2">
    â± Tambah 5 Menit
  </button>
</div>

</div>
</div>

<script>
/* ================= CONFIG ================= */
// âš ï¸ GANTI DENGAN URL TUNNEL KAMU
const WSS_URL = "wss://red-offset-dry-treasury.trycloudflare.com";

/* ================= MATRIX ================= */
function buildMatrix(id){
  const m=document.getElementById(id);
  for(let i=0;i<64;i++){
    const d=document.createElement("div");
    d.className="cell";
    m.appendChild(d);
  }
}
["matrix-main","matrix-top","matrix-bottom"].forEach(buildMatrix);

/* ================= BLOOM ================= */
function bloom(matrix,temp,max){
  const c=3.5;
  const level=Math.min(temp/max,1)*4;
  for(let y=0;y<8;y++){
    for(let x=0;x<8;x++){
      const d=Math.max(Math.abs(x-c),Math.abs(y-c));
      matrix.children[y*8+x].style.background =
        d<=level ? "#fb923c" : "#1f2937";
    }
  }
}

/* ================= CHART ================= */
function makeChart(id,color){
  return new Chart(document.getElementById(id),{
    type:"line",
    data:{labels:[],datasets:[{data:[],borderColor:color,tension:.35}]},
    options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false}}}
  });
}
const chartMain=makeChart("chart-main","#ef4444");
const chartTop=makeChart("chart-top","#f97316");
const chartBottom=makeChart("chart-bottom","#dc2626");

/* ================= WEBSOCKET ================= */
let ws;

function connectWS(){
  console.log("ğŸ”„ Connecting to", WSS_URL);
  ws=new WebSocket(WSS_URL);

  ws.onopen=()=>console.log("âœ… WebSocket CONNECTED");

  ws.onclose=e=>{
    console.log("âŒ WS CLOSED, retry...");
    setTimeout(connectWS,3000);
  };

  ws.onerror=e=>{
    console.error("ğŸ”¥ WS ERROR",e);
  };

  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    console.log("ğŸ“¥ DATA",d);

    document.getElementById("status").textContent="ONLINE";

    document.getElementById("main-temp").textContent =
      d.main_temp+" Â°C";

    bloom(matrix-main,d.main_temp,200);
    bloom(matrix-top,d.top_temp,160);
    bloom(matrix-bottom,d.bottom_temp,180);

    timer-top.textContent=
      Math.floor(d.top_remaining/60)+":"+
      String(d.top_remaining%60).padStart(2,"0");

    timer-bottom.textContent=
      Math.floor(d.bottom_remaining/60)+":"+
      String(d.bottom_remaining%60).padStart(2,"0");

    chartMain.data.datasets[0].data.push(d.main_temp);
    chartTop.data.datasets[0].data.push(d.top_temp);
    chartBottom.data.datasets[0].data.push(d.bottom_temp);

    if(chartMain.data.datasets[0].data.length>60){
      chartMain.data.datasets[0].data.shift();
      chartTop.data.datasets[0].data.shift();
      chartBottom.data.datasets[0].data.shift();
    }

    chartMain.update();
    chartTop.update();
    chartBottom.update();
  };
}

connectWS();

/* ================= CONTROL ================= */
function toggleAlarm(zone,btn){
  const on=btn.textContent.includes("OFF");
  btn.textContent=on?"ğŸ”” Alarm ON":"ğŸ”” Alarm OFF";
  btn.classList.toggle("bg-red-600",on);
  btn.classList.toggle("bg-gray-600",!on);

  ws.send(JSON.stringify({
    type:"alarm",
    zone:zone,
    value:on
  }));
}

alarm-top.onclick=()=>toggleAlarm("top",alarm-top);
alarm-bottom.onclick=()=>toggleAlarm("bottom",alarm-bottom);

add5-top.onclick=()=>ws.send(JSON.stringify({type:"timer",zone:"top"}));
add5-bottom.onclick=()=>ws.send(JSON.stringify({type:"timer",zone:"bottom"}));
</script>

</body>
</html>
